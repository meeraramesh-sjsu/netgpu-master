/* 
	MODULE:Throughputs dumper 
	TYPE: Hook

	PrePreprocessor orders (ppp.sh): 
	###PATTERNS $THROUGHPUTS$DUMPER$DUMP_ALARMS_TO_FILE(); $THROUGHPUTS$DUMPER$DUMP_ALARMS_TO_STDERR();

*/

//#warning  Througputs Dumper Hook loaded

#include <iostream>
#include "../hostTimeUtils.h"

/* FILE DUMPER MACRO */
#define $THROUGHPUTS$DUMPER$PREPARE_TO_DUMP_ALARMS_TO_FILE(filename)\
	{bool alreadyExists;\
	ofstream os;\
	fstream fin;\
	fin.open(filename,ios::in);\
	alreadyExists = fin.is_open();\
	fin.close();\
	os.open(filename,ios::out | ios::app);\
	if(!alreadyExists){\
	        os<< "#AutoGenerated Output by"STR(APP_NAME)" Rate Module"<<endl;\
        	os << "#Throughputs alarm output(line): ANALYSIS_NAME> USER_TYPE{TYPE1_VALUE TYPE2_VALUE ... TYPEN_VALUE} RATE(magnitude/second) COUNTER (total sum of magnituds in elapsed time)"<<endl;\
        	/*os << "#Total d time format: #ANALYSIS_NAME> Total number of alarms: NUM_OF_ELEMENTS //At the end list of histogram if counter >0"<<endl; */\
        	os << "#Elapsed time format: #ANALYSIS_NAME>[ ANALYSIS_START_TIME(timestamp) ANALYSIS_END_TIME(timestamp) ] dumpedTime_ info//At the end list of histogram"<<endl<<endl<<endl;\
	}\
	DUMPER()


#define $THROUGHPUTS$DUMPER$DUMP_ALARMS_TO_FILE()\
	os << results[i*ANALYSIS_TPB+j].rate<<" "<< results[i*ANALYSIS_TPB+j].counter<<endl;\
	}}}\
	$THROUGHPUTS$DUMPER$TIMESTAMPS_DUMPER()\
	os.close();}do{}while(0)

/* STDERR DUMPER MACRO */
#define $THROUGHPUTS$DUMPER$PREPARE_TO_DUMP_ALARMS_TO_STDERR()\
	{ostream& os = cerr;\
	$THROUGHPUTS$DUMPER$DUMPER()

#define $THROUGHPUTS$DUMPER$DUMP_ALARMS_TO_STDERR()\
	os << results[i*ANALYSIS_TPB+j].rate<<" "<< results[i*ANALYSIS_TPB+j].counter<<endl;\
	}}}\
	$THROUGHPUTS$DUMPER$TIMESTAMPS_DUMPER()\
	}do{}while(0)


/* ------------ Common for both dumpers -------------- */



/*DUMPER CODE (common) */
#define $THROUGHPUTS$DUMPER$DUMPER()\
	int i,j;\
	bool hasResults;\
	time_t aux;\
  	struct tm * timeinfo;\
	uint8_t* pointer __attribute__ ((unused));\
	for(i = 0,hasResults = false;i<state.windowState.totalNumberOfBlocks;i++){\
		for(j = 0;j<auxBlocks[i];j++){\
			if(results[i*ANALYSIS_TPB+j].rate != 0.0){\
				hasResults = true;\
				os<<STR(ANALYSIS_NAME)"> "
	
/* TIMESTAMPS DUMPER CODE (common)*/
#define $THROUGHPUTS$DUMPER$TIMESTAMPS_DUMPER()\
	if(hasResults){\
		os<<"#"STR(ANALYSIS_NAME)"> ";\
		os<<"[ "<<tv2usec(state.windowState.windowStartTime)<<" ";\
		os<<tv2usec(state.windowState.windowEndTime)<<" ] ";\
		time ( &aux );\
		timeinfo = localtime ( &aux );\
	        os << " Dumped at: "<<asctime(timeinfo)<<endl<<endl;\
	}




/* FIELD DUMPERS (common)*/

//Simple types
#define $THROUGHPUTS$DUMPER$ADD_FIELD()\
	os<<results[i*ANALYSIS_TPB+j].user<<" "

//Special dumpers
#define $THROUGHPUTS$DUMPER$ADD_FIELD_AS_NETMASK()\
	$THROUGHPUTS$DUMPER$ADD_FIELD_AS_IP()

#define $THROUGHPUTS$DUMPER$ADD_FIELD_AS_IP()\
	pointer = (uint8_t*)&results[i*ANALYSIS_TPB+j].user;\
	os<<(unsigned int)*(pointer+3)<<"."<<(unsigned int)*(pointer+2)<<"."<<(unsigned int)*(pointer+1)<<"."<<(unsigned int)*(pointer)<<"" 

//Structure types

#define $THROUGHPUTS$DUMPER$ADD_FIELD_COMPLEX(field)\
	os<<results[i*ANALYSIS_TPB+j].user.field<<" "
//Special dumpers
#define $THROUGHPUTS$DUMPER$ADD_FIELD_AS_NETMASK_COMPLEX(field)\
	$THROUGHPUTS$DUMPER$ADD_FIELD_AS_IP_COMPLEX(field)

#define $THROUGHPUTS$DUMPER$ADD_FIELD_AS_IP_COMPLEX(field)\
	pointer = (uint8_t*)&results[i*ANALYSIS_TPB+j].user.field;\
	os<<(unsigned int)*(pointer+3)<<"."<<(unsigned int)*(pointer+2)<<"."<<(unsigned int)*(pointer+1)<<"."<<(unsigned int)*(pointer)<<" "
