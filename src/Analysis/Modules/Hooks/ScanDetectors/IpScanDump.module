/* 
	MODULE:IpScan dumper 
	TYPE: Hook

	PrePreprocessor orders (ppp.sh): 
	###PATTERNS $IPSCAN_DETECTOR$DUMPER$DUMP_ALARMS_TO_FILE( $IPSCAN_DETECTOR$DUMPER$DUMP_ALARMS_TO_STDERR(

 */

//#warning  IpScan Dumper Hook loaded

#include <iostream>
#include <iomanip>
#include <arpa/inet.h>
#include <stdbool.h>
#include <stdio.h>
#include<string>
#include<vector>
using namespace std;
#include "../hostTimeUtils.h"

//3,11,7,15,1,0
void printFlagBits(int flags)
{
/*	if(flags&64) cout<<"Congestion Window Reduced ";
	if(flags&32) cout<<"ECN Echo ";
	if(flags&16) cout<<"ACK ";
	if(flags&8) cout<<"PSH(Push) ";
	if(flags&4) cout<<"RST ";
	if(flags&2) cout<<"SYN ";
	if(flags&1) cout<<"FIN "; */
	if(flags & 3) cout<<"SYN FIN";
	if(flags & 11) cout<<"PSH SYN FIN";
	if(flags & 7) cout<<"RST SYN FIN";
	if(flags & 15) cout<<"PSH RST SYN FIN";
	if(flags & 1) cout<<"FIN";
	if(flags&0) cout<<"NONE ";
}

#define $IPSCAN_DETECTOR$DUMPER$DUMP_ALARMS_TO_FILE(filename,severe,critical)\
		dumpIpScanAlarmsToFile(packetBuffer,results,state,auxBlocks,(char*)filename,severe,critical,result,pattern,index)

//int *result,char* pattern,int *index
#define $IPSCAN_DETECTOR$DUMPER$DUMP_ALARMS_TO_STDERR(severe,critical)\
		dumpIpScanAlarmsToOstream(cerr, packetBuffer,results,state,auxBlocks,severe,critical)

template<typename R>
void inline dumpIpScanAlarmsToFile(PacketBuffer* packetBuffer,R* results, analysisState_t state, int64_t* auxBlocks, char* filename,int severeLimit, int criticalLimit, int *result,char *pattern,int *index){

	//cout<<"TCP = "<<(*results).indexTcp<<"UDP= "<< (*results).indexUdp<<"ICMP ="<< (*results).indexIcmp;
	cout<<endl<<"*********************CPU SECTION***********************************"<<endl;
	//cout<<"TCP = "<<results[0].indexTcp<<"UDP= "<< results[0].indexUdp<<"ICMP = "<< results[0].indexIcmp<<endl;
	bool alreadyExists;
	ofstream file;
	fstream fin;

	//If File does not exist mark flag
	fin.open(filename,ios::in);
	alreadyExists = fin.is_open();
	fin.close();

	//Open
	file.open(filename,ios::out | ios::app);

	//If was empty, fill with headers
	if(!alreadyExists){
		file << "#AutoGenerated Output by"STR(APP_NAME)" IpScanDetector Module"<<endl;
		file << "#Elapsed time format: [ ANALYSIS_START_TIME(timestamp) ANALYSIS_END_TIME(timestamp) ] //At the end list of alarms"<<endl;
		file << "#Alarm Output Format: ANALYSIS_NAME> IP_SOURCE RATE(ips/second) IPS_COUNTER(number of different ips) ALARM_TYPE"<<endl<<endl;
	}

	dumpIpScanAlarmsToOstream(file, packetBuffer,results,state,auxBlocks,severeLimit,criticalLimit,result,pattern,index);

	//TODO: leave it opened till the end
	file.close();

}

template<typename R>
void inline dumpIpScanAlarmsToOstream(ostream& os, PacketBuffer* packetBuffer,R* results, analysisState_t state, int64_t* auxBlocks, int severeLimit, int criticalLimit,int *result,char* pattern,int *index){
	int i,j;
	bool hasResults;
	uint8_t* pointer;
	//time vars	
	time_t aux;
	struct tm * timeinfo;
	int noofStr = results[0].num_strings;
	//Dump alarms
	cout<<"*************Crafted Packets***************"<<endl;
	cout<<"No Of Malicious virus signatures used "<<noofStr<<endl;
	int totalcycles = 0;
	int incorrectVerNumber = 0;
	vector<struct in_addr> maliciousSrcIPs;
	bool malicious = false;
	for(i = 0;i<state.lastPacket;i++){
		uint32_t network_byte_order, network_byte_order1;
		uint32_t some_long;
		struct in_addr in,out;
		totalcycles += results[i].timeTaken;			
		if(results[i].ipPacket)
		{
			some_long = results[i].ipSrc;
			network_byte_order = htonl(some_long);
			in.s_addr = network_byte_order;
			some_long = results[i].ipDst;
			network_byte_order1 = htonl(some_long);
			out.s_addr = network_byte_order1;
		}
	/*	if(results[i].maliciousVer)
		{
			incorrectVerNumber++;
			cout<<"Traffic has incorrect version numer";
			cout<<"From source IP Address";
			cout<<inet_ntoa(in);
			malicious = true;
			cout<<endl;
		}*/
		if(results[i].maliciousIP)
		{
			cout<<"Alarm!! Src address or Destination address is in private Address range:";
			cout<<"Source IP = " << inet_ntoa(in)<<" ";
			cout<<"Destination IP = " << inet_ntoa(out)<<" ";
			malicious = true;
			cout<<endl;
		}
		if(results[i].maliciousFlags)
		{
			cout<<"Alarm!! Malicious Flag bit combinations found: i.e ";
			printFlagBits(results[i].flags);
			malicious = true;
			cout<<" are set ; from source IP address"<<inet_ntoa(in)<<endl;
		}
		if(results[i].maliciousReserved)
		{
			cout<<"Alarm!! Reserved bits are set, the packet is from src Address:";
			cout<<inet_ntoa(in);
			malicious = true;
			cout<<endl;
		}
		if(results[i].maliciousPort)
		{
			malicious = true;
			if(results[i].sport==0)
				cout<<"Alarm!! TCP Packet from src Address "<<inet_ntoa(in)<<"has source Port set to zero!";
			else
				cout<<"Alarm!! TCP Packet from src Address"<<inet_ntoa(in)<< "has destination Port set to zero!";
			cout<<endl;
		}
		if(results[i].maliciousAck)
		{
			malicious = true;
			cout<<"Alarm!! TCP Packet has acknowledgement bit set and ACK number is zero";
			cout<<"Packet from "<<inet_ntoa(in)<<"should be blocked"<<endl;
		}
		if(results[i].maliciousDst)
		{
			malicious = true;
			cout<<"Alarm!! TCP Broadcast Packet! with address"<<inet_ntoa(out);
			cout<<endl;
		}
		if(results[i].maliciousCheckSum)
		{
			malicious = true;
			cout<<"Alarm!! The IPv4 Packet has an incorrect checksum and should be discarded"<<endl;
			cout<<"From"<<inet_ntoa(in)<<endl;
		}
		if(results[i].maliciousPayload)
		{  
			cout<<"**************Deep packet Inspection*************************"<<endl;
			malicious = true;
			cout<<"Alarm!! The traffic from source IP "<<inet_ntoa(in)<<" has virus signatures injected"<<endl;
			cout<<"The virus pattern is ";
			int start = index[2*results[i].signatureNumber];
			int end = index[2*results[i].signatureNumber+1];
			for(int j=start;j<end;j++)
			cout<<pattern[j]<<endl;
		}
		maliciousSrcIPs.push_back(in);
	}
	
		for(int i=0;i<noofStr;i++)
		{
			if(result[i])
			{
				cout<<"************************************************";
				cout<<"Virus pattern found: ";
				int start = index[2*i];
				int end = index[2*i+1];
				for(int j=start;j<end;j++)
					cout<<pattern[j];
				cout<<endl;
			}
		}
	
		cout<<"Traffic from the following source IPs should be blocked"<<endl;
		for(int i=0;i<maliciousSrcIPs.size();i++)
		{
			cout<<inet_ntoa(maliciousSrcIPs[i])<<endl;
		}
		
	totalcycles = totalcycles / (824);
	cout<<"Clock Frequency = "<<setw(2)<<totalcycles<<" us"<<endl;
	
	if(hasResults){
		//Analysis start timestamp (1rst packet)
		os<<"#"STR(ANALYSIS_NAME)"> ";
		os<<"[ "<<tv2usec(state.windowState.windowStartTime)<<" "; 	
		//Seek to supress stupid \n from ctime
		//	os.seekp(ios_base::cur-1);	

		//Analysis end timestamp (last packet)

		os<<tv2usec(state.windowState.windowEndTime)<<" ] ";		

		//Dump current time (time of the dump)
		time ( &aux );
		timeinfo = localtime ( &aux );
		os << " Dumped at: "<<asctime(timeinfo)<<endl<<endl;
	}
	cout<<"Alarm!! There are "<<incorrectVerNumber<<" packets Which have incorrect version Number! "<<endl;

}

